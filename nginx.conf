events {
    worker_connections 256;  # Further reduced for memory constraints
    use epoll;  # More efficient event model
    multi_accept on;  # Accept multiple connections at once
}

http {
    access_log off;
    error_log off;  # Disable error logging to save memory
    
    # Memory-optimized settings
    client_body_buffer_size 1k;  # Minimal buffer size
    client_header_buffer_size 1k;  # Minimal header buffer
    large_client_header_buffers 2 1k;  # Minimal large header buffers
    client_max_body_size 1k;  # Minimal body size
    
    # Optimized connection limits for memory constraints
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:1m;  # Reduced from 5m
    limit_conn conn_limit_per_ip 100;  # Reduced from 200

    upstream backend_servers {
        server backend-01:8080 max_conns=50;  # Reduced from 100
        server backend-02:8080 max_conns=50;  # Reduced from 100
        keepalive 8;  # Reduced from 16
        keepalive_requests 100;  # Limit requests per connection
        keepalive_timeout 30s;  # Shorter timeout
    }

    server {
        listen 9999;
        
        # Reduced connection limits per location
        limit_conn conn_limit_per_ip 50;  # Reduced from 100

        location / {
            proxy_pass http://backend_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Aggressive timeouts to prevent connection buildup
            proxy_connect_timeout 2s;  # Reduced from 3s
            proxy_send_timeout 5s;     # Reduced from 10s
            proxy_read_timeout 5s;     # Reduced from 10s
            
            # Memory-efficient keepalive
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Buffer optimizations
            proxy_buffering off;  # Disable buffering to save memory
            proxy_request_buffering off;  # Disable request buffering
        }
    }
}